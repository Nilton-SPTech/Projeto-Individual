<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="../css/usuario/index.css">
    <link rel="stylesheet" href="../css/reset.css">
</head>
<body>
    


    <div class="div_modal">
        <div class="div_escolha">
            <div class="div_card">
                <div class="div_professor"  id="div_professor">
                    <img class="img_professor" src="../assets/img_usuario/professor.png">
                    <img class="img_pokemon" id="img_pokemon" src="../assets/gif/bulbassaur-animacao.gif" >

                    <img class="img_emoji" id="img_emoji">
                </div>


                <div class="fundo_normal" id="div_pokemon" style="display: none;">
                    <div class="div_topo">
                        <div class="div_nome">
                            <div class="div_nome_especifico">
                                <span class="s_basic">Basic</span>
                                <span id="s_nome">Pikachu</span>
                            </div>
                            <div>
                                <span class="s_hp">HP</span>
                                <span id="s_vida">60</span>
                            </div>
                        </div>
                        <div class="div_imagem_pokemon">
                            <img id="img_pokemon_escolha" src="../assets/gif/pikachu-animacao.gif">
                        </div>
                    </div>
                    <div class="div_meio">
                        <div class="div_primeiro_ataque">
                            <h3 id="primeiro_ataque">Iron Tail <span>15x</span></h3>
                            <p>Esse ataque tem uma alta chance de crítico, mas um dano muito baixo.</p>
                        </div>
                        <div class="div_segundo_ataque">
                            <h3 id="segundo_ataque">Iron Secretária <span>30x</span></h3>
                            <p>Esse ataque tem um dano muito alto, mas uma chance grande de errar o alvo.</p>
                        </div>
                    </div>
                    <div class="div_baixo">
                        <div class="div_descricao">
                            <p id="descricao">Lorem ipsum dolor sit amet consectetur adipisicing elit. Magnam, molestiae culpa unde magni ab eos atque optio nostrum.</p>
                        </div>
                    </div>
                </div>


            </div>
            <div class="div_texto">
                <div class="div_esquerdo"></div>
                <div class="div_conversa" id="div_conversa">   

                                 
                </div>
                <div class="div_direito"></div>
            </div>
        </div>
    </div>


    
</body>
</html>
<script src="../js/funcao_listar_pokemon.js"></script>


<script>

    texto()

    var nome = sessionStorage.NOME_USUARIO
    var vetor = [
        `Olá mestre Pokemon ${nome}!`,
        'Prazer em te conhecer, eu me chamo Professor Carvalho, e eu serei o seu guia nessa grande jornada. ',
        `proximo`, 
        `O mundo Pokemon é repleto de maravilhas e curiosidades, seus monstrinhos de bolso vão te auxiliar durante as batalhas.`,
        `Acumule pontos batalhando e chegue mais próximo do sonho de se tornar o maior mestre Pokemon.`,
        `proximo`,
        `Está preparado para viver essa aventura?`,
        `pergunta`,
        `Ótimo! Então eu irei te ajudar a escolher seu companheiro nessa grande jornada.`, 
        `Hehe, fique tranquilo. Eu sempre estarei  do seu lado caso precise de uma luz, agora vamos escolher seu companheiro para essa grande jornada.`,
        `proximo`,
        `Escolha somente um dentre os três para ser seu companheiro:`, 
        'opcao',
        'proximo', 
    ]
    
    var j = 11

    function texto(){
        div_conversa.innerHTML = ""

        if(j == 11){
            img_emoji.classList.toggle('aparecer_img_emoji')
        }

        var i = 0
        var palavra = setInterval(() => {
            
            // MOSTRANDO AS FRASES QUE NÃO SÃO 'proximo'
            if(vetor[j] != "proximo"){
                div_conversa.innerHTML += vetor[j][i] 
                
                i++
                var validar_tamanho = i == vetor[j].length 
                if(validar_tamanho){
                    i = 0
                    j++
                    console.log("Chegamos no fim")
                }
            }

            // APARECENDO A IMAGEM DO POKEMON NO BLOCO 2
            if(j == 3){
                img_pokemon.classList.toggle('aparecer_imagem_pokemon')
            }
            if(j == 6){
                img_pokemon.classList.toggle('aparecer_imagem_pokemon')
            }
            
            // VALIDANDO SE O CONTEUDO DO ARRAY É 'pergunta'
            var validar_pergunta = vetor[j] == "pergunta"
            if(validar_pergunta){
                clearInterval(palavra)
                j++
                div_conversa.innerHTML += `<br>
                <div class="div_pergunta">
                    <button onclick="pergunta('sim')">Sim</button>
                    <button onclick="pergunta('nao')">Não</button>
                </div>
                `
            }

            var validar_opcao = vetor[j] == "opcao"
            var opcao_verdadeiro = false
            if(validar_opcao){
                j++
                opcao()
                clearInterval(palavra)
                opcao_verdadeiro = true

            }

            //VALIDANDO SE O CONTEUDO DO ARRAY É 'proximo'
            var validar_proximo = vetor[j] == "proximo" && !opcao_verdadeiro
            if(validar_proximo){
                clearInterval(palavra)
                j++
                div_conversa.innerHTML += `<br><button onclick="texto()">Prosseguir</button>`
            }
            
            // DANDO ESPAÇAMENTO CASO O CONTEUDO NÃO SEJA 'proximo' E validar_tamanho FOR VERDADEIRO
            if(!validar_proximo && validar_tamanho){
                div_conversa.innerHTML += '<br><br>'
            }
        }, 60)
    }


    // DANDO O SRC DO EMOJI
    var src_emoji = "../assets/img_usuario/"
    function pergunta(resposta){
        div_conversa.innerHTML = ""
        var i = 0

        // OPERADOR TERNÁRIO PARA VALIDAR SE A RESPOSTA É 'sim' OU 'nao'
        j = resposta == 'sim' ? 8 : 9
        // OPERADOR TERNARIO PARA VALIDAR SE O j ESTÁ NA POCIÇÃO 8 OU 9
        src_emoji += j == 8 ? "feliz_emoji.png" : "alivio_emoji.png"
        // PASSANDO O SRC PARA DENTRO DA IMG
        img_emoji.src = src_emoji
        // MOSTRANDO A IMG NA TELA
        img_emoji.classList.toggle('aparecer_img_emoji')

        // LAÇO DE REPETIÇÃO COM INTERVALO PARA PERCORRER AS FRASES
        var frase = setInterval(() => {
            if(vetor[j] != "proximo"){
                div_conversa.innerHTML += vetor[j][i] 
                
                i++
                var validar_tamanho = i == vetor[j].length 

                if(validar_tamanho){
                    // OPERADOR TERNARIO PARA VALIDAR SE O j ESTÁ NA POSIÇÃO 8 OU 9
                    j = j == 8 ? 10 : j + 1
                    i = 0
                    console.log("Chegamos no fim")
                }
            }
            if(j == 10){
                clearInterval(frase)
                j++
                div_conversa.innerHTML += `<br><button onclick="texto()">Prosseguir</button>`
            }
        }, 60)
    }


    // opcao()
    function opcao(){

        div_professor.style.display = 'none'
        div_pokemon.style.display = 'block'

        div_conversa.innerHTML += `
        <form class="div_pokemon_opcao" id="form_pokemon_opcao">
            <div class="div_pokemon_especifico">
                <h3 id="h3_nome">Charmander</h3>
                <div class="div_img_pokemon">
                    <img src="../assets/pokemon/charmander-frente.png"> 
                </div>
                <input type="radio" id="in_charmander" name="pokemon" onclick=" selecionar('Charmander')">
            </div>
            <div class="div_pokemon_especifico">
                <h3 id="h3_nome">Squirtle</h3>
                <div class="div_img_pokemon">
                    <img src="../assets/pokemon/squirtle-frente.png"> 
                </div>
                <input type="radio" id="in_charmander" name="pokemon" onclick=" selecionar('Squirtle')">
            </div>
            <div class="div_pokemon_especifico">
                <h3 id="h3_nome">Bulbasaur</h3>
                <div class="div_img_pokemon">
                    <img src="../assets/pokemon/bulbassaur-frente.png"> 
                </div>
                <input type="radio" id="in_charmander" name="pokemon" onclick=" selecionar('Bulbasaur')">
            </div>
        </form>    
        <br>
        <button onclick="cadastrar_pokemon()">Selecionar Pokemon</button>
        `
    }

    function selecionar(nome){
        fetch("/pokemons/listar_pokemon", {cache: 'no-store'})
        .then(function (response){
            if(response.ok){
                response.json().then(function (resposta){
                    listar_opcao(resposta, nome)
                })
            }
            else{
                console.log("Nenhuma dado encontrado ou erro na API")
            }
        })
        .catch(function(error){
            console.log(`Erro na obtenção dos dados do select: ${error.message}`)
        })
    }

    var id_pokemon
    function listar_opcao(pokemons, nome){
        var vetor_pokemon = []

        for(var i = 0; i < pokemons.length; i++){
            var pokemon = pokemons[i]
            if(pokemon.nome == nome){
                vetor_pokemon.push(pokemon)
            }
        }

        id_pokemon = vetor_pokemon[0].idPokemon
        s_nome.innerHTML = vetor_pokemon[0].nome
        s_vida.innerHTML = vetor_pokemon[0].vidaTotal
        primeiro_ataque.innerHTML = vetor_pokemon[0].ataqueFraco
        segundo_ataque.innerHTML = vetor_pokemon[0].ataqueForte
        descricao.innerHTML = vetor_pokemon[0].descricao
        img_pokemon_escolha.src = `../assets/gif/${vetor_pokemon[0].enderecoGif}`

        div_pokemon.classList.remove('fundo_normal')

        if(nome == 'Charmander'){
            div_pokemon.classList.add('fundo_fogo')
            div_pokemon.classList.remove('fundo_agua')
            div_pokemon.classList.remove('fundo_grama')
        }

        if(nome == 'Squirtle'){
            div_pokemon.classList.remove('fundo_fogo')
            div_pokemon.classList.add('fundo_agua')
            div_pokemon.classList.remove('fundo_grama')
        }

        if(nome == 'Bulbasaur'){
            div_pokemon.classList.remove('fundo_fogo')
            div_pokemon.classList.remove('fundo_agua')
            div_pokemon.classList.add('fundo_grama')
        }
    }


    function cadastrar_pokemon(){
        console.log(id_pokemon)

        var id_usuario = sessionStorage.ID_USUARIO

        if(id_pokemon != undefined){
            fetch("/pokemons/cadastrar_pokemon_usuario", {
                method: "POST", 
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    usuarioServer: id_usuario, 
                    pokemonServer: id_pokemon
                })
            })
            .then(function (resposta){
                console.log("resposta ", resposta)
    
                if(resposta.ok){
                    console.log("cadastro feito com sucesso")
                    texto()
                }
                else{
                    throw("Houve um erro ao tentar realizar o cadastro")
                }
            })
            .catch(function(resposta){
                console.log(`#ERRO: ${resposta}`)
            })
        }
        else{
            alert("Selecione um pokemon")
        }
    }
</script>