<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/usuario/batalha_pokemon.css">

</head>
<body>
    
    <div class="div_batalha">
        <div class="div_pokemon_adversario">

            <div class="div_informacoes_pokemon_adversario">
                <div class="div_nome_level">
                    <span class="s_nome" id="s_nome_adversario"></span>
                    <span class="s_level">Lv3</span>
                </div>
                <div class="div_hp">
                    <span>HP</span>
                    <div class="div_barra_hp">
                        <div id="s_barra"></div>
                    </div>
                </div>
            </div>


            <!-- IMAGEM DO POKEMON -->
            <div class="div_pokemon_adversario_imagem">
                <img  id="img_pokemon_adversario">
            </div>

        </div>

        <div class="div_pokemon_jogador">

            <!-- IMAGEM DO POKEMON -->
            <div class="div_pokemon_jogador_imagem">
                <img id="img_pokemon_jogador">
            </div>




            <div class="div_informacoes_pokemon_jogador">
                <div class="div_nome_level">
                    <span class="s_nome" id="s_nome_jogador"></span>
                    <span class="s_level">Lv3</span>
                </div>
                <div class="div_hp">
                    <span>HP</span>
                    <div class="div_barra_hp">
                        <div id="s_barra"></div>
                    </div>
                </div>
                <div class="div_pontos_vida">
                    <span id="s_vida_atual">0</span>
                    <span>/</span>
                    <span id="s_vida_total">0</span>

                </div>
            </div>
        </div>


    </div>

    <div class="div_caixa_dialogo">

        <div class="div_dialogo_opcao">


            <div id="div_opcao_texto" class="div_opcao_texto" >
                <div>
                    <span id="s_texto"></span> 
                </div>
            </div>

            <div id="div_opcao_ataque" class="div_opcao_ataque" style="display: none;">
                <div class="div_ataque_encima">
                    <span 
                        onmouseover="descricao_ataque(1)"
                        onclick="atacar(1)"
                        id="s_ataque_fraco"
                    >ATAQUE FRACO</span>
                    <span 
                        onmouseover="descricao_ataque(2)"
                        onclick="curar()"
                    >CURAR</span>
                </div>

                <div class="div_ataque_embaixo">
                    <span 
                        onmouseover="descricao_ataque(3)"
                        onclick="defender()"
                    >DEFENDER</span>
                    <span 
                        onmouseover="descricao_ataque(4)"
                        onclick="atacar(2)"
                        id="s_ataque_forte"
                    >ATAQUE FORTE</span>
                </div>
            </div>

            <div class="div_opcao_navegacao">

                <div id="div_opcao_escolha" class="div_opcao_escolha" >
                    <div class="div_cima">
                        <span onclick="batalhar()">LUTAR</span>
                        <span class="s_passar_turno" onclick="">PASSAR TURNO</span>
                    </div>
                    <div class="div_baixo">
                        <span>FUGIR</span>
                    </div>
                </div>

                <div id="div_descricao_ataque" class="div_descricao_ataque" style="display: none;">
                    <div class="div_cima">
                        <span class="s_pp">PP</span>
                        <div id="div_valores_pp">
                            <span class="s_pp_atual" id="s_pp_atual"></span>
                            <span class="s_pp_total" id="s_pp_total"></span>
                        </div>
                    </div>

                    <div class="div_baixo">
                        <span class="s_tipo">TIPO/</span>
                        <span class="s_ataque_tipo" id="s_ataque_tipo"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>


</body>
</html>

<script>

    // FUNÇÃO PARA GERAR UM POKEMON ADVERSARIO DE FORMA ALEATORIA 
    var adversario = [ 
        {nome: "Dratini",  img: 'dratini.png', ataque: "mordida"},
        {nome: "Ekans",  img: 'ekans.png', ataque: "mordida"},
        {nome: "Exeggcute",  img: 'exeggcute.png', ataque: "chicote de vinha"},
        {nome: "Gastly",  img: 'gastly.png', ataque: "lambida"},
        {nome: "koffing",  img: 'koffing.png', ataque: "encontrão" },
        {nome: "zubat",  img: 'zubat.png', ataque: "mordida"},
    ]

    gerar_adversario()
    var adversario_atual
    function gerar_adversario(){
        var pocisao = parseInt(Math.random() * 6)

        var pokemon = adversario[pocisao]
        img_pokemon_adversario.src = `../assets/pokemon_adversario/${pokemon.img}`
        s_nome_adversario.innerHTML = (pokemon.nome).toUpperCase()
        adversario_atual = pokemon
    }

    // JSON QUE CONTEM A DECRIÇÃO DO ATAQUE
    var ataque_fraco = 
    {
        pp_atual: 20, 
        pp_total: 20, 
        tipo: 'eletrico', 
        dano: 10,
        critico: 45
    }
    var ataque_forte = 
    {
        pp_atual: 10, 
        pp_total: 10, 
        tipo: 'eletrico', 
        dano: 25,
        critico: 15
    }
    var cura = 
    {
        pp_atual: 15, 
        pp_total: 15, 
        tipo: 'cura', 
    }
    var defesa = 
    {
        pp_atual: 10, 
        pp_total: 10, 
        tipo: 'defesa', 
    }
    

    function descricao_ataque(id){

        var tipo = ''
        var pp_atual = 0
        var pp_total = 0

        var cor = ''
        var quantidade = 0 
        switch (id) {
            case 1:
                tipo = ataque_fraco.tipo
                pp_atual = ataque_fraco.pp_atual 
                pp_total = ataque_fraco.pp_total

                quantidade = 30
            break;

            case 2:
                tipo = cura.tipo
                pp_atual = cura.pp_atual 
                pp_total = cura.pp_total

                quantidade = 40
            break;

            case 3:
                tipo = defesa.tipo
                pp_atual = defesa.pp_atual 
                pp_total = defesa.pp_total

                quantidade = 50
            break;
        
            default:
                tipo = ataque_forte.tipo
                pp_atual = ataque_forte.pp_atual 
                pp_total = ataque_forte.pp_total

                quantidade = 40
                break;
            }
            
        var porcentagem = (pp_total / 100) * quantidade
        if(pp_atual <= porcentagem){
            cor = "#ff3c01"
        }
        s_pp_atual.innerHTML = pp_atual
        s_pp_total.innerHTML = `/${pp_total}`
        s_ataque_tipo.innerHTML = tipo.toUpperCase()
        div_valores_pp.style.color = cor
    }

    function batalhar(){
        div_opcao_texto.style.display = "none"
        div_opcao_ataque.style.display = "flex"
        div_opcao_escolha.style.display = "none"
        div_descricao_ataque.style.display = "block"
    }

    // FUNÇÕES DOS ATAQUES DOS POKEMONS
    function curar(){
        
        var cura_atual = cura.pp_atual
        if( cura_atual > 0){
            cura.pp_atual -= 1
            descricao_ataque(2)

            pokemon_texto = pokemon_atual
            cura_texto = 10

            adicionar_vida(-cura_texto, 1)
            frases[2] = `${pokemon_texto} curou ${cura_texto} pontos de vida.`
            texto(2)

            setTimeout(() => {
                    atacar_adversario()
            }, 4600);
        }
    }

    function defender(){

        var defesa_atual =  defesa.pp_atual
        if(defesa_atual > 0){
            defesa.pp_atual -= 1
            descricao_ataque(3)
        }
    }

    function atacar(ataque){
        var ataque_atual

        if(ataque == 1){
            ataque_atual = ataque_fraco.pp_atual

            if(ataque_atual > 0){
                ataque_fraco.pp_atual -= 1
                descricao_ataque(1)
                var validar_critico = critico(ataque_forte.critico)

                if(!validar_critico){
                    tirar_vida(15, 0)
                    
                    //PASSANDO A FUNÇÃO QUE MOSTRA O TEXTO DO DANO NA TELA
                    pokemon_texto = pokemon_atual
                    ataque_texto = ataque_fraco_nome
    
                    // ATUALIZANDO O VETOR
                    frases[0] = `${pokemon_texto} atacou com ${ataque_texto}.`
                    texto(0)
                }
                else{
                    tirar_vida(35, 0)
                    
                    //PASSANDO A FUNÇÃO QUE MOSTRA O TEXTO DO DANO NA TELA
                    pokemon_texto = pokemon_atual
                    ataque_texto = ataque_fraco_nome
    
                    // ATUALIZANDO O VETOR
                    frases[3] = `${pokemon_texto} acaba de acertar um ataque crítico com ${ataque_texto}!`
                    texto(3)
                }

                setTimeout(() => {
                    atacar_adversario()
                }, 4600);
            }
        }
        else{
            ataque_atual = ataque_forte.pp_atual
            if(ataque_atual > 0){
                ataque_forte.pp_atual -= 1
                descricao_ataque(4)
                
                var validar_critico = critico(ataque_forte.critico)

                if(!validar_critico){
                    tirar_vida(25, 0)
                    
                    //PASSANDO A FUNÇÃO QUE MOSTRA O TEXTO DO DANO NA TELA
                    pokemon_texto = pokemon_atual
                    ataque_texto = ataque_forte_nome
    
                    // ATUALIZANDO O VETOR
                    frases[0] = `${pokemon_texto} atacou com ${ataque_texto}.`
                    texto(0)
                }
                else{
                    tirar_vida(40, 0)
                    
                    //PASSANDO A FUNÇÃO QUE MOSTRA O TEXTO DO DANO NA TELA
                    pokemon_texto = pokemon_atual
                    ataque_texto = ataque_forte_nome
    
                    // ATUALIZANDO O VETOR
                    frases[3] = `${pokemon_texto} acaba de acertar um ataque crítico com ${ataque_texto}!`
                    texto(3)
                }

                setTimeout(() => {
                    atacar_adversario()
                }, 4600);
                
            }
        }
    }

    function atacar_adversario(){

        var dano = parseInt(1 + Math.random() * 20) 
        tirar_vida(dano, 1)

        //PASSANDO A FUNÇÃO QUE MOSTRA O TEXTO DO DANO NA TELA
        pokemon_texto = adversario_atual.nome
        ataque_texto = adversario_atual.ataque

        // ATUALIZANDO O VETOR
        frases[0] = `${pokemon_texto} atacou com ${ataque_texto}.`
        texto(0)

        setTimeout(() => {
            div_opcao_escolha.style.display = "block"
        }, 3000);


    }

    function critico(porcentagem){
        var porcentagem_critico = parseInt(1 + Math.random() * 256)
        var num = parseInt((porcentagem / 100) * 100)
        var variacao = (num * 10) - porcentagem_critico 

        if(porcentagem_critico < variacao && porcentagem_critico > num){
            return true
        }
        else{
            return false
        }

    }






    // FUNÇÃO QUE TIRA A VIDA DO JOGADAOR
    //VARIAVEL DO TAMANHO DA BARRA E A PORCENTAGEM DO WIDTH
    // ESSA FUNÇÃO DEVE SER ARRUMADA
    var vida_adversario = 100
    var vida_atual_adversario = vida_adversario
    var porcentagem_barra = 0
    var porcentagem_barra_adversario = 0

    var barra_vida = 0
    var barra_vida_adversario = 0
    
    var vida 
    function tirar_vida(dano, recebe){
        
        if(recebe == 1){
            vida_atual = vida_atual - dano
            vida = vida_atual
            var porcentagem = (dano / vida_total) * 100
            console.log(vida_atual)

            porcentagem_barra += porcentagem
            var porcentage_barra_vida = 100 - porcentagem_barra
            barra_vida = vida > 0 ? porcentage_barra_vida : 0
            s_barra[recebe].style.width = `${barra_vida}%`
                        
            s_vida_atual.innerHTML = vida_atual
            if(vida_atual < 0 ){
                s_vida_atual.innerHTML = 0
            }

        }
        else{
            vida_atual_adversario = vida_atual_adversario - dano
            vida = vida_atual_adversario
            var porcentagem = (dano / vida_adversario) * 100
            console.log(vida_atual_adversario)

            porcentagem_barra_adversario += porcentagem
            var porcentage_barra_vida_adversario = 100 - porcentagem_barra_adversario
            barra_vida_adversario = vida > 0 ? porcentage_barra_vida_adversario : 0
            s_barra[recebe].style.width = `${barra_vida_adversario}%`
        }
    
    }


    function adicionar_vida(cura, recebe){
        if(recebe == 1){


            if(vida_atual < vida_total){
                vida_atual = vida_atual - cura
                vida = vida_atual
                var porcentagem = (cura / vida_total) * 100
    
                porcentagem_barra += porcentagem
                var porcentage_barra_vida = 100 - porcentagem_barra
                barra_vida = vida > 0 ? porcentage_barra_vida : 0
                
                s_barra[recebe].style.width = `${barra_vida}%`

                var tamanho = (s_barra[recebe].style.width).replaceAll("%", "")
                tamanho = Number(tamanho)
                
                if(tamanho > 100){
                    var conta_barra = tamanho - 100
                    s_barra[recebe].style.width = `${tamanho - conta_barra}%`
                    console.log(conta_barra)
                }
                
                s_vida_atual.innerHTML = vida_atual
                if(vida_atual > vida_total ){
                    s_vida_atual.innerHTML = vida_total
                }
            }





        }
        else{
            vida_atual_adversario = vida_atual_adversario - cura
            vida = vida_atual_adversario
            var porcentagem = (cura / vida_adversario) * 100
            console.log(vida_atual_adversario)

            porcentagem_barra_adversario += porcentagem
            var porcentage_barra_vida_adversario = 100 - porcentagem_barra_adversario
            barra_vida_adversario = vida > 0 ? porcentage_barra_vida_adversario : 0
            s_barra[recebe].style.width = `${barra_vida_adversario}%`
        }

    }
</script>


<script>

    pegar_pokemon()
    function pegar_pokemon(){

        var usuarioVar = sessionStorage.ID_USUARIO
        var pokemonVar = 1

        fetch("/pokemons/listar_pokemon_batalha", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                usuarioServer: usuarioVar,
                pokemonServer: pokemonVar
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                
                resposta.json().then(json => {
                    listar_pokemon(json)
                    console.log(json);
            
                });
            } else {
                console.log("Houve um erro ao tentar pegar o pokemon");
            }
        }).catch(function (erro) {
            console.log(erro);
        })
    }

    var pokemon_atual 
    var ataque_fraco_nome 
    var ataque_forte_nome
    function listar_pokemon(dado){

        img_pokemon_jogador.src = `../assets/icon/${dado[0].enderecoImagemCosta}`
        pokemon_atual = (dado[0].nome).toUpperCase()
        s_nome_jogador.innerHTML = pokemon_atual

        ataque_fraco_nome = (dado[0].ataqueFraco).toUpperCase()
        ataque_forte_nome = (dado[0].ataqueForte).toUpperCase()
        s_ataque_fraco.innerHTML = ataque_fraco_nome
        s_ataque_forte.innerHTML = ataque_forte_nome

        vida_atual = dado[0].vidaTotal
        vida_total = dado[0].vidaTotal

        s_vida_total.innerHTML = vida_total
        s_vida_atual.innerHTML = vida_atual


        ataque_fraco.tipo = dado[0].tipoPrimario
        ataque_forte.tipo = dado[0].tipoPrimario
    }


</script>


<script>

    var pokemon_texto = ''
    var adversario_texto = ''
    var cura_texto = 0
    var ataque_texto = ''

    var frases = [
        //VETOR 0 É PARA INFORMAR O ATAQUE NORMAL
        ``, 

        //VETOR 1 É PARA INFORMAR A DEFESA 
        `${pokemon_texto} está em modo de defesa, isso reduzira o dano do ${adversario_texto}.`,

        // VETOR 2 É PARA INFORMAR A CURA 
        ``,

        //VETOR 3 É PARA INFORMAR O CRÍTICO 
        ``,

        //VETOR 4 É PARA INFORMAR SE ELE SE DESVIOU DO ATAQUE
        `${pokemon_texto} desviou do ${ataque_texto}.`
    ]

  
    function texto(pocisao){
        
        s_texto.innerHTML = ''

        div_opcao_texto.style.display = "block"
        div_opcao_ataque.style.display = "none"
        div_descricao_ataque.style.display = "none"

        var i = 0
        var palavra = setInterval(() => {
            var frase_atual = frases[pocisao]
            s_texto.innerHTML += frase_atual[i].toUpperCase()
            i++

            if(i == frase_atual.length){
                clearInterval(palavra)
            }
        }, 60)
    }
</script>